{% extends 'layout.html' %}

{% block title %}Gestión de Usuarios | Puff-tóricos{% endblock %}

{% block content %}
<div class="container-xl">
    <div class="card bg-dark text-light shadow-lg border-0 rounded-4 overflow-hidden mx-auto">
        <div class="card-header bg-dark">
            <h1 class="h3 text-white">Gestión de Usuarios</h1>
            <p class="text-white-50">Aquí puedes gestionar los usuarios del sistema.</p>
        </div>
        <div class="card-body">
            <div class="bg-dark card p-4 border rounded-3 shadow-sm mb-5">
                <h3 class="fw-bold mb-4 border-bottom pb-2 text-white">Registrar Nuevo Usuario</h3>
                <form id="add-user-form" class="row g-3 align-items-end" action="{{ url_for('users.index')}}"
                    method="post">

                    <div class="col-md-6 col-lg-3">
                        <label for="add-first-name" class="form-label fw-semibold text-white">Nombre</label>
                        <input type="text" id="add-first-name" name="first_name" placeholder="Ej: Juan" required
                            class="form-control rounded-3">
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <label for="add-last-name" class="form-label fw-semibold text-white">Apellido</label>
                        <input type="text" id="add-last-name" name="last_name" placeholder="Ej: Pérez" required
                            class="form-control rounded-3">
                    </div>

                    <div class="col-md-12 col-lg-4">
                        <label for="add-email" class="form-label fw-semibold text-white">Email</label>
                        <input type="email" id="add-email" name="email" placeholder="ejemplo@dominio.com" required
                            class="form-control rounded-3">
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="add-password" class="form-label fw-semibold text-white">Contraseña</label>
                        <input type="password" id="add-password" name="password" placeholder="Mínimo 8 caracteres" required class="form-control rounded-3">
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="add-active" class="form-label fw-semibold text-white">Estado</label>
                        <select id="add-active" name="active" class="form-select rounded-3">
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <label for="add-role" class="form-label fw-semibold text-white">Rol</label>
                        <select id="add-role" name="role" class="form-select rounded-3">
                            <option value="" selected>Seleccionar Rol</option>
                        </select>
                    </div>

                    <div class="col-md-12 col-lg-2 d-grid">
                        <button type="submit" class="btn btn-primary fw-bold py-2 rounded-3 shadow-sm">
                            Crear Usuario
                        </button>
                    </div>
                </form>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4 pt-4 border-top">
                <h2 class="h4 fw-bold text-white mb-0">Listado de Usuarios</h2>
                <div class="d-flex gap-2">
                    <input type="text" id="search-email" placeholder="Buscar por email..." class="form-control form-control-sm" style="width: 200px;">
                    <select id="filter-status" class="form-select form-select-sm" style="width: 130px;">
                        <option value="">Todos los estados</option>
                        <option value="active">Activos</option>
                        <option value="inactive">Inactivos</option>
                    </select>
                    <select id="filter-role" class="form-select form-select-sm" style="width: 150px;">
                        <option value="">Todos los roles</option>
                    </select>
                    <button id="boton-buscar" class="btn btn-secondary">Buscar</button>
                </div>
            </div>

            <div id="table-container" class="table-responsive rounded-3 shadow-sm">
                <table class="table table-dark table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col" class="py-3 px-4">ID</th>
                            <th scope="col" class="py-3 px-4">Nombre Completo</th>
                            <th scope="col" class="py-3 px-4">Email</th>
                            <th scope="col" class="py-3 px-4 text-center">Estado</th>
                            <th scope="col" class="py-3 px-4 text-center">Rol</th>
                            <th scope="col" class="py-3 px-4 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td class="py-3 px-4 fw-bold text-white">{{ user.id }}</td>
                            <td class="py-3 px-4 text-white">{{ user.first_name }} {{ user.last_name }}</td>
                            <td class="py-3 px-4 font-monospace small text-white">{{ user.email }}</td>
                            <td class="py-3 px-4 text-center">
                                {% if user.active %}
                                <span class="badge text-bg-success py-2 px-3">
                                    <i class="fas fa-check-circle me-1"></i> Activo
                                </span>
                                {% else %}
                                <span class="badge text-bg-danger py-2 px-3">
                                    <i class="fas fa-times-circle me-1"></i> Inactivo
                                </span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 text-center">
                                {% if user.role %}
                                    <span class="badge text-bg-info py-2 px-3 text-dark">{{ user.role.name }}</span>
                                {% else %}
                                    {% if user.sys_admin %}
                                        <span class="badge text-bg-warning py-2 px-3 text-dark">
                                            <i class="fas fa-crown me-1"></i> SystemAdmin
                                        </span>
                                    {% else %}
                                        <span class="badge text-bg-secondary py-2 px-3">
                                            <i class="fas fa-user me-1"></i> Unknown
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            
                            <td class="py-3 px-4 text-center">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button type="button" class="btn btn-primary btn-sm rounded-2 fw-semibold px-3 btn-editar" data-user-id="{{ user.id }}">
                                        <i class="fas fa-edit me-1"></i> Editar
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm rounded-2 fw-semibold px-3 btn-borrar" data-user-id="{{ user.id }}">
                                        <i class="fas fa-trash me-1"></i> Borrar
                                    </button>
                                    {% if user.active %}
                                        <button type="button" class="btn btn-warning btn-sm rounded-2 fw-semibold px-3 btn-bloquear" data-user-id="{{ user.id }}">
                                            <i class="fas fa-trash me-1"></i> Bloquear
                                        </button>
                                    {% else %}
                                      <button type="button" class="btn btn-success btn-sm rounded-2 fw-semibold px-3 btn-bloquear" data-user-id="{{ user.id }}">
                                            <i class="fas fa-trash me-1"></i> Desbloquear
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/roles/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const addRoleSelect = document.getElementById('add-role');
                    data.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        addRoleSelect.appendChild(option);
                    });

                    const filterRoleSelect = document.getElementById('filter-role');
                    if (filterRoleSelect) {
                        data.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.id; 
                            option.textContent = role.name;
                            filterRoleSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error al cargar los roles:', error));
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.btn-editar').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    location.href = `/users/update/${userId}`;
                });
            });
            
            
            document.querySelectorAll('.btn-borrar').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    
                    if (confirm('¿Estás seguro de que quieres borrar este usuario? Esta acción no se puede deshacer.')) {
                        fetch(`/users/delete/${userId}`, {
                            method: 'POST'
                        })
                        .then(response => {
                            if (response.ok) {
                                location.reload();
                            } else {
                                alert('Error al borrar el usuario. Por favor, inténtalo de nuevo.');
                            }
                        });
                    }
                });
            });

            document.querySelectorAll('.btn-bloquear').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    
                    fetch(`/users/deactivate/${userId}`, {
                        method: 'POST'
                    })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error al bloquear el usuario. Por favor, inténtalo de nuevo.');
                        }
                    });
                });
            });
        });
    </script>
    <script>
        function filterUsers() {
            const email = document.getElementById('search-email').value;
            const status = document.getElementById('filter-status').value;
            const role = document.getElementById('filter-role').value;
            
            const params = new URLSearchParams();
            if (email) params.append('email', email);
            if (status) params.append('status', status);
            if (role) params.append('role', role);
            
            fetch(`/users/search/?${params.toString()}`)
                .then(response => response.json())
                .then((data) => {
                    updateUserTable(data.users);
                })
                .catch((error) => console.error('Error:', error));
        }

        function updateUserTable(users) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = ''; 
            
            users.forEach(user => {
                const row = createUserRow(user); 
                tbody.appendChild(row);
            });
        }

        function createUserRow(user) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-3 px-4 fw-bold text-dark">${user.id}</td>
                <td class="py-3 px-4">${user.first_name} ${user.last_name}</td>
                <td class="py-3 px-4 font-monospace small">${user.email}</td>
                <td class="py-3 px-4 text-center">
                    <span class="badge ${user.active ? 'text-bg-success' : 'text-bg-danger'} py-2 px-3">
                        ${user.active ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td class="py-3 px-4 text-center">
                    ${user.role ? `<span class="badge text-bg-info py-2 px-3">${user.role.name}</span>` : '<span class="badge text-bg-secondary py-2 px-3">Sin rol</span>'}
                </td>
                <td class="py-3 px-4 text-center">
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-warning btn-sm btn-editar" data-user-id="${user.id}">
                            <i class="fas fa-edit me-1"></i> Editar
                        </button>
                        <button type="button" class="btn btn-danger btn-sm btn-borrar" data-user-id="${user.id}">
                            <i class="fas fa-trash me-1"></i> Borrar
                        </button>
                    </div>
                </td>
            `;
            return row;
        }
    </script>
    <script>
        document.getElementById('boton-buscar').addEventListener('click', function(event) {
            event.preventDefault(); 
            filterUsers(); 
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

{% endblock %}