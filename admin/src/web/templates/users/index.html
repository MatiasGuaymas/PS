{% extends "layout.html" %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block content %}

<div class="container-xl p-3">
    <div class="card bg-dark text-light shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-dark d-flex justify-content-between align-items-center">
            <h2 class="h3 text-white mb-0">Gestión de Usuarios</h2>
            <button class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#nuevoUsuarioForm">
                <i class="bi bi-person-plus-fill"></i> Nuevo Usuario
            </button>
        </div>

        <div id="nuevoUsuarioForm" class="collapse">
            <div class="card-body p-4" style="background-color: #7053b390;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h5 text-white mb-0">Registrar Nuevo Usuario</h3>
                    <button type="button" class="btn btn-sm btn-outline-light" id="btn-ocultar-form">
                        <i class="bi bi-x-lg"></i> Ocultar
                    </button>
                </div>
                <form id="add-user-form" class="row g-3" action="{{ url_for('users.index') }}" method="post">
                    <div class="col-md-3">
                        <label for="add-first-name" class="form-label text-white">Nombre</label>
                        <input type="text" id="add-first-name" name="first_name" placeholder="Ej: Juan" required
                            class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="add-last-name" class="form-label text-white">Apellido</label>
                        <input type="text" id="add-last-name" name="last_name" placeholder="Ej: Pérez" required
                            class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="add-email" class="form-label text-white">Email</label>
                        <input type="email" id="add-email" name="email" placeholder="ejemplo@dominio.com" required
                            class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="add-password" class="form-label text-white">Contraseña</label>
                        <input type="password" id="add-password" name="password" placeholder="Mínimo 8 caracteres"
                            required class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="add-active" class="form-label text-white">Estado</label>
                        <select id="add-active" name="active" class="form-select">
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="add-role" class="form-label text-white">Rol</label>
                        <select id="add-role" name="role" class="form-select">
                            <option value="" selected>Seleccionar Rol</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-white invisible">Acción</label>
                        <button type="submit" class="btn btn-success w-100 d-block">Crear Usuario</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card-body p-4">

            <form id="search-form" class="mb-4">
                <div class="row g-3 justify-content-center">
                    <div class="col-md-3">
                        <input type="text" id="search-email" name="email" placeholder="Buscar por email..."
                            class="form-control" value="">
                    </div>
                    <div class="col-md-2">
                        <select id="filter-status" name="status" class="form-select">
                            <option value="">Todos los estados</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="filter-role" name="role" class="form-select">
                            <option value="">Todos los roles</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="sort-order" name="sort_order" class="form-select">
                            <option value="desc">Más nuevos primero</option>
                            <option value="asc">Más viejos primero</option>
                        </select>
                    </div>
                    <div class="col-md-auto d-flex">
                        <button type="button" id="boton-buscar" class="btn btn-primary mx-1">Buscar</button>
                        <button type="button" id="boton-limpiar" class="btn btn-secondary mx-1">Limpiar</button>
                    </div>
                </div>
            </form>

            <div id="no-results" style="display: none;">
                <p>No se encontraron resultados.</p>
            </div>

            <div id="table-container">
                <p id="user-count"></p>
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover rounded-3 overflow-hidden">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Nombre Completo</th>
                                <th scope="col">Email</th>
                                <th scope="col" class="text-center">Estado</th>
                                <th scope="col" class="text-center">Rol</th>
                                <th scope="col" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            {% for user in users %}
                            <tr>
                                <td>{{ user.first_name }} {{ user.last_name }}</td>
                                <td>{{ user.email }}</td>
                                <td class="text-center">
                                    {% if user.active %}
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;"
                                        title="Activo"></i>
                                    {% else %}
                                    <i class="bi bi-x-circle-fill text-danger" style="font-size: 1.2rem;"
                                        title="Inactivo"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if user.role %}
                                    <span class="badge bg-primary">{{ user.role.name }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Sin rol</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-warning btn-sm btn-editar mx-1"
                                        data-user-id="{{ user.id }}"><i class="bi bi-pencil-fill"></i>Editar</button>
                                    {% if user.deleted %}
                                    <button type="button" class="btn btn-success btn-sm btn-restaurar mx-1"
                                        data-user-id="{{ user.id }}"><i class="bi bi-arrow-counterclockwise"></i>Restaurar</button>
                                    {% else %}
                                    <button type="button" class="btn btn-danger btn-sm btn-borrar mx-1"
                                        data-user-id="{{ user.id }}"><i class="bi bi-trash-fill"></i>Borrar</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div id="pagination-controls" class="d-flex justify-content-center mt-4">
                    <button onclick="prevPage()" id="prev-button" class="btn btn-secondary me-2"
                        disabled>Anterior</button>
                    <span id="page-info" class="align-self-center me-2">Página 1</span>
                    <button onclick="nextPage()" id="next-button" class="btn btn-secondary">Siguiente</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    let currentFilters = {
        email: '',
        status: '',
        role: '',
        sort_order: 'desc'
    };

    document.addEventListener('DOMContentLoaded', function () {
        loadRoles();
        attachInitialEventListeners();

        // Ocultar form
        document.getElementById('btn-ocultar-form').addEventListener('click', function () {
            const collapseElement = document.getElementById('nuevoUsuarioForm');
            const bsCollapse = new bootstrap.Collapse(collapseElement, {
                toggle: true
            });
        });
    });

    function loadRoles() {
        fetch('/roles/')
            .then(response => response.ok ? response.json() : Promise.reject('Error al cargar roles'))
            .then(data => {
                const addRoleSelect = document.getElementById('add-role');
                const filterRoleSelect = document.getElementById('filter-role');

                data.forEach(role => {
                    // Para el formulario de agregar usuario
                    const addOption = document.createElement('option');
                    addOption.value = role.id;
                    addOption.textContent = role.name;
                    addRoleSelect.appendChild(addOption);

                    // Para el filtro
                    const filterOption = document.createElement('option');
                    filterOption.value = role.id;
                    filterOption.textContent = role.name;
                    filterRoleSelect.appendChild(filterOption);
                });
            })
            .catch(error => console.error('Error al cargar los roles:', error));
    }

    // Setear event listeners iniciales
    function attachInitialEventListeners() {
        document.getElementById('boton-buscar').addEventListener('click', function (e) {
            e.preventDefault();
            currentPage = 1;
            updateFiltersFromForm();
            filterUsers();
        });
        document.getElementById('boton-limpiar').addEventListener('click', function (e) {
            e.preventDefault();
            clearFilters();
        });
        attachActionListeners();
    }

    // Actualizar filtros
    function updateFiltersFromForm() {
        currentFilters.email = document.getElementById('search-email').value;
        currentFilters.status = document.getElementById('filter-status').value;
        currentFilters.role = document.getElementById('filter-role').value;
        currentFilters.sort_order = document.getElementById('sort-order').value;
    }

    // Limpiar filtros
    function clearFilters() {
        document.getElementById('search-email').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-role').value = '';
        document.getElementById('sort-order').value = 'desc';

        currentFilters = {
            email: '',
            status: '',
            role: '',
            sort_order: 'desc'
        };

        currentPage = 1;
        filterUsers();
    }

    // Filtrar usuarios
    function filterUsers() {
        const params = new URLSearchParams();

        if (currentFilters.email) params.append('email', currentFilters.email);
        if (currentFilters.status) params.append('status', currentFilters.status);
        if (currentFilters.role) params.append('role', currentFilters.role);

        params.append('sort_by', 'id');
        params.append('sort_order', currentFilters.sort_order);
        params.append('page', currentPage);

        fetch(`/users/search/?${params.toString()}`)
            .then(response => response.ok ? response.json() : Promise.reject('Error en la búsqueda'))
            .then(data => {
                updateUserTable(data.users);
                updatePaginationControls(data.pagination);
                updateUserCount(data.pagination.total);
            })
            .catch(error => {
                console.error('Error:', error);
                showNoResults();
            });
    }

    // Actualización de tabla de usuarios
    function updateUserTable(users) {
        const tbody = document.getElementById('users-tbody');
        const noResults = document.getElementById('no-results');
        const tableContainer = document.getElementById('table-container');

        if (users.length === 0) {
            showNoResults();
            return;
        }

        noResults.style.display = 'none';
        tableContainer.style.display = 'block';

        tbody.innerHTML = '';

        users.forEach(user => {
            const row = createUserRow(user);
            tbody.appendChild(row);
        });

        attachActionListeners();
    }

    function createUserRow(user) {
        const row = document.createElement('tr');

        const activeIcon = user.active
            ? '<i class="bi bi-check-circle-fill text-success" style="font-size: 1.2rem;" title="Activo"></i>'
            : '<i class="bi bi-x-circle-fill text-danger" style="font-size: 1.2rem;" title="Inactivo"></i>';

        const roleBadge = user.role
            ? `<span class="badge bg-primary">${user.role.name}</span>`
            : '<span class="badge bg-secondary">Sin rol</span>';

        const actionButton = user.deleted
        ? `<button type="button" class="btn btn-success btn-sm btn-restaurar mx-1" data-user-id="${user.id}" data-action="restore"><i class="bi bi-arrow-counterclockwise"></i>Restaurar</button>`
        : `<button type="button" class="btn btn-danger btn-sm btn-borrar mx-1" data-user-id="${user.id}" data-action="delete"><i class="bi bi-trash-fill"></i>Borrar</button>`;


        row.innerHTML = `
            <td>${user.first_name} ${user.last_name}</td>
            <td>${user.email}</td>
            <td class="text-center">${activeIcon}</td>
            <td class="text-center">${roleBadge}</td>
            <td class="text-center">
                <button type="button" class="btn btn-warning btn-sm btn-editar mx-1" data-user-id="${user.id}"><i class="bi bi-pencil-fill"></i>Editar</button>
                ${actionButton}
            </td>
        `;

        return row;
    }

    // Acciones de editar y borrar
    function attachActionListeners() {
        document.querySelectorAll('.btn-editar').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.getAttribute('data-user-id');
                location.href = `/users/update/${userId}`;
            });
        });

        document.querySelectorAll('.btn-borrar, .btn-restaurar').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.getAttribute('data-user-id');
                const action = this.getAttribute('data-action');

                let title, text, confirmButtonText, confirmButtonColor, actionUrl;

                if (action === 'restore') {
                    title = '¿Deseas restaurar este usuario?';
                    text = "El usuario volverá a estar activo en el sistema.";
                    confirmButtonText = 'Sí, restaurar';
                    confirmButtonColor = '#28a745'; 
                    actionUrl = `/users/restore/${userId}`; 
                } else { // action === 'delete'
                    title = '¿Estás seguro de borrar?';
                    text = "Esta acción lo marcará como borrado lógicamente.";
                    confirmButtonText = 'Sí, borrar';
                    confirmButtonColor = '#d33'; 
                    actionUrl = `/users/delete/${userId}`; 
                }

                Swal.fire({
                    title: title,
                    text: text,
                    icon: action === 'restore' ? 'info' : 'warning',
                    showCancelButton: true,
                    confirmButtonColor: confirmButtonColor,
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, borrar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonText: confirmButtonText
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = actionUrl;
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    }

    // Actualización de paginación
    function updatePaginationControls(pagination) {
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageInfo = document.getElementById('page-info');

        pageInfo.textContent = `Página ${pagination.page} de ${pagination.pages}`;

        prevButton.disabled = !pagination.has_prev;
        nextButton.disabled = !pagination.has_next;

        currentPage = pagination.page;
    }

    function updateUserCount(total) {
        const userCount = document.getElementById('user-count');
        userCount.textContent = `${total} usuarios encontrados.`;
    }

    function showNoResults() {
        const noResults = document.getElementById('no-results');
        const tableContainer = document.getElementById('table-container');

        noResults.style.display = 'block';
        tableContainer.style.display = 'none';
    }

    // Paginar
    function nextPage() {
        if (!document.getElementById('next-button').disabled) {
            currentPage++;
            filterUsers();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            filterUsers();
        }
    }
</script>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
{% endblock %}