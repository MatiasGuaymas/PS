{% extends "layout.html" %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJc5fD1x3vP2BJKz/42/qVnQ+eDk5c4h5N+Vw/H/Ew4D3q0H2+586LpLw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            min-height: 100vh;
            padding-top: 3rem;
            padding-bottom: 3rem;
        }
        /* Clase para el color de la cabecera (azul profundo similar al indigo-700) */
        .bg-indigo-700-bs {
            background-color: #3730a3; /* Un tono oscuro de índigo/violeta */
        }
    </style>
{% endblock %}

{% block content %}

<div class="container-xl">
    <div class="card bg-dark text-light shadow-lg border-0 rounded-4 overflow-hidden mx-auto">
        <div class="card-header bg-dark">
            <h1 class="h3">Gestión de Usuarios</h1>
            <p>Aquí puedes gestionar los usuarios del sistema.</p>
        </div>
        <div class="card-body">
            <div class="bg-dark card p-4 border rounded-3 shadow-sm mb-5">
                <h3 class="fw-bold mb-4 border-bottom pb-2">Registrar Nuevo Usuario</h3>
                <form id="add-user-form" class="row g-3 align-items-end" action="{{ url_for('users.index')}}"
                    method="post">

                    <div class="col-md-6 col-lg-3">
                        <label for="add-first-name" class="form-label fw-semibold">Nombre</label>
                        <input type="text" id="add-first-name" name="first_name" placeholder="Ej: Juan" required
                            class="form-control rounded-3">
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <label for="add-last-name" class="form-label fw-semibold ">Apellido</label>
                        <input type="text" id="add-last-name" name="last_name" placeholder="Ej: Pérez" required
                            class="form-control rounded-3">
                    </div>

                    <div class="col-md-12 col-lg-4">
                        <label for="add-email" class="form-label fw-semibold ">Email</label>
                        <input type="email" id="add-email" name="email" placeholder="ejemplo@dominio.com" required
                            class="form-control rounded-3">
                    </div>
                        
                        <div class="col-md-6 col-lg-4">
                            <label for="add-password" class="form-label fw-semibold text-muted">Contraseña</label>
                            <input type="password" id="add-password" name="password" placeholder="Mínimo 8 caracteres" required class="form-control rounded-3">
                        </div>
                        
                        <div class="col-md-6 col-lg-4">
                            <label for="add-active" class="form-label fw-semibold text-muted">Estado</label>
                            <select id="add-active" name="active" class="form-select rounded-3">
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>

                        <div class="col-md-6 col-lg-4">
                            <label for="add-role" class="form-label fw-semibold text-muted">Rol</label>
                            <select id="add-role" name="role" class="form-select rounded-3">
                                <option value="" selected>Seleccionar Rol</option>
                            </select>
                        </div>

                        <div class="col-md-12 col-lg-2 d-grid">
                            <button type="submit" class="btn btn-primary fw-bold py-2 rounded-3 shadow-sm">
                                Crear Usuario
                            </button>
                        </div>
                    </div>

                <div class="d-flex justify-content-between align-items-center mb-4 pt-4 border-top">
                    <h2 class="h4 fw-bold text-dark mb-0">Listado de Usuarios</h2>
                    <div class="d-flex gap-2">
                        <input type="text" id="search-email" placeholder="Buscar por email..." class="form-control form-control-sm" style="width: 200px;">
                        <select id="filter-status" class="form-select form-select-sm" style="width: 130px;">
                            <option value="">Todos los estados</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                        </select>
                        <select id="filter-role" class="form-select form-select-sm" style="width: 150px;">
                            <option value="">Todos los roles</option>
                        </select>
                        
                        <select id="sort-order" class="form-select form-select-sm" style="width: 160px;">
                            <option value="desc">Más reciente</option>
                            <option value="asc">Más antiguo</option>
                        </select>

                        <button id="boton-buscar">Buscar</button>
                    </div>
                </div>
                <div id="table-container" class="table-responsive rounded-3 shadow-sm">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="py-3 px-4">ID</th>
                                <th scope="col" class="py-3 px-4">Nombre Completo</th>
                                <th scope="col" class="py-3 px-4">Email</th>
                                <th scope="col" class="py-3 px-4 text-center">Estado</th>
                                <th scope="col" class="py-3 px-4 text-center">Rol</th>
                                <th scope="col" class="py-3 px-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td class="py-3 px-4 fw-bold text-dark">{{ user.id }}</td>
                                <td class="py-3 px-4">{{ user.first_name }} {{ user.last_name }}</td>
                                <td class="py-3 px-4 font-monospace small">{{ user.email }}</td>
                                
                                <td class="py-3 px-4 text-center">
                                    {% if user.active %}
                                    <span class="badge text-bg-success py-2 px-3">
                                        <i class="fas fa-check-circle me-1"></i> Activo
                                    </span>
                                    {% else %}
                                    <span class="badge text-bg-danger py-2 px-3">
                                        <i class="fas fa-times-circle me-1"></i> Inactivo
                                    </span>
                                    {% endif %}
                                </td>
                                
                                <td class="py-3 px-4 text-center">
                                    {# Mostrar el rol asociado si existe #}
                                    {% if user.role %}
                                        <span class="badge text-bg-primary py-2 px-3">{{ user.role.name }}</span>
                                    {% else %}
                                        {# Fallback: si no hay rol, indicar admin o usuario según sys_admin #}
                                        {% if user.sys_admin %}
                                            <span class="badge text-bg-warning py-2 px-3 text-dark">
                                                <i class="fas fa-crown me-1"></i> SystemAdmin
                                            </span>
                                        {% else %}
                                            <span class="badge text-bg-secondary py-2 px-3">
                                                <i class="fas fa-user me-1"></i> Unknown
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                
                                <td class="py-3 px-4 text-center">
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button type="button" class="btn btn-warning btn-sm rounded-2 fw-semibold px-3 btn-editar" data-user-id="{{ user.id }}">
                                            <i class="fas fa-edit me-1"></i> Editar
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm rounded-2 fw-semibold px-3 btn-borrar" data-user-id="{{ user.id }}">
                                            <i class="fas fa-trash me-1"></i> Borrar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Controles de paginación -->
                <div id="pagination-container" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
                    <div id="pagination-info" class="text-muted">
                        <!-- Información de paginación -->
                    </div>
                    <nav aria-label="Paginación de usuarios">
                        <ul id="pagination-controls" class="pagination pagination-sm mb-0">
                            <!-- Controles de paginación se generarán con JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/roles/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const addRoleSelect = document.getElementById('add-role');
                    data.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        addRoleSelect.appendChild(option);
                    });

                    const filterRoleSelect = document.getElementById('filter-role');
                    if (filterRoleSelect) {
                        data.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.id; 
                            option.textContent = role.name;
                            filterRoleSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error al cargar los roles:', error));
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.btn-editar').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    location.href = `/users/update/${userId}`;
                });
            });
            
            
            document.querySelectorAll('.btn-borrar').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    
                    if (confirm('¿Estás seguro de que quieres borrar este usuario? Esta acción no se puede deshacer.')) {
                        // Crear un formulario y enviarlo
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `/users/delete/${userId}`;
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    </script>
    <script>
        function filterUsers(page = 1) {
            const email = document.getElementById('search-email').value;
            const status = document.getElementById('filter-status').value;
            const role = document.getElementById('filter-role').value;

            const sortBy = 'created_at';
            const sortOrder = document.getElementById('sort-order').value;
            
            const params = new URLSearchParams();
            if (email) params.append('email', email);
            if (status) params.append('status', status);
            if (role) params.append('role', role);

            params.append('sort_by', sortBy);
            if (sortOrder) params.append('sort_order', sortOrder);
            
            params.append('page', page);

            fetch(`/users/search/?${params.toString()}`)
                    .then(response => response.json())
                .then(data => {
                    updateUserTable(data.users);
                    updateSortIndicators(data.sort_by, data.sort_order);
                    updatePaginationControls(data.pagination);
                })
                .catch(error => console.error('Error:', error));
        }

        function updateSortIndicators(sortBy, sortOrder) {
            document.getElementById('sort-order').value = sortOrder;
            
            const headers = document.querySelectorAll('th');
            headers.forEach(header => {
                header.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            if (sortBy === 'created_at') {
                const dateHeader = document.querySelector('th[data-sort="created_at"]');
                if (dateHeader) {
                    dateHeader.classList.add(sortOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            }
        }

        function updateUserTable(users) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = ''; 
            
            users.forEach(user => {
                const row = createUserRow(user); 
                tbody.appendChild(row);
            });
        }

        function createUserRow(user) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-3 px-4 fw-bold text-dark">${user.id}</td>
                <td class="py-3 px-4">${user.first_name} ${user.last_name}</td>
                <td class="py-3 px-4 font-monospace small">${user.email}</td>
                <td class="py-3 px-4 text-center">
                    <span class="badge ${user.active ? 'text-bg-success' : 'text-bg-danger'} py-2 px-3">
                        ${user.active ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td class="py-3 px-4 text-center">
                    ${user.role ? `<span class="badge text-bg-primary py-2 px-3">${user.role.name}</span>` : '<span class="badge text-bg-secondary py-2 px-3">Sin rol</span>'}
                </td>
                <td class="py-3 px-4 text-center">
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-warning btn-sm btn-editar" data-user-id="${user.id}">
                            <i class="fas fa-edit me-1"></i> Editar
                        </button>
                        <button type="button" class="btn btn-danger btn-sm btn-borrar" data-user-id="${user.id}">
                            <i class="fas fa-trash me-1"></i> Borrar
                        </button>
                    </div>
                </td>
            `;
            return row;
        }
    </script>
    <script>
        function updatePaginationControls(pagination) {
            const paginationInfo = document.getElementById('pagination-info');
            const paginationControls = document.getElementById('pagination-controls');
            const paginationContainer = document.getElementById('pagination-container');
            
            // Actualizar información de paginación
            if (pagination.total > 0) {
                const start = (pagination.page - 1) * pagination.per_page + 1;
                const end = Math.min(pagination.page * pagination.per_page, pagination.total);
                paginationInfo.innerHTML = `Mostrando ${start}-${end} de ${pagination.total} usuarios`;
            } else {
                paginationInfo.innerHTML = 'No se encontraron usuarios';
            }
            
            // Generar controles de paginación solo si hay más de una página
            if (pagination.pages > 1) {
                let paginationHTML = '';
                
                // Botón anterior
                if (pagination.has_prev) {
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="filterUsers(${pagination.prev_num}); return false;">
                                Anterior
                            </a>
                        </li>
                    `;
                }
                
                // Números de página
                for (let i = 1; i <= pagination.pages; i++) {
                    const isActive = i === pagination.page ? 'active' : '';
                    paginationHTML += `
                        <li class="page-item ${isActive}">
                            <a class="page-link" href="#" onclick="filterUsers(${i}); return false;">
                                ${i}
                            </a>
                        </li>
                    `;
                }
                
                // Botón siguiente
                if (pagination.has_next) {
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="filterUsers(${pagination.next_num}); return false;">
                                Siguiente
                            </a>
                        </li>
                    `;
                }
                
                paginationControls.innerHTML = paginationHTML;
                paginationContainer.style.display = 'flex';
            } else {
                // Ocultar controles si no hay paginación necesaria
                paginationContainer.style.display = 'none';
            }
        }
    </script>
    <script>
        document.getElementById('boton-buscar').addEventListener('click', function(event) {
            event.preventDefault(); 
            filterUsers(); 
        });
    </script>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
{% endblock %}