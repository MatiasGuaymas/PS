{% extends "layout.html" %}

{% block title %}Registrar Sitio Hist贸rico | Puff-t贸ricos{% endblock %}

{% block head %}
{{ super() }}
<style>
/* Estilos necesarios para la selecci贸n de tags, copiados de la template de edici贸n */
.tags-multiselect {
    background-color: #2d2d2d;
    border: 1px solid #4b0082;
    border-radius: 4px;
    padding: 8px;
    min-height: 120px;
    max-height: 200px;
    overflow-y: auto;
}

.tag-option {
    padding: 6px 12px;
    margin: 2px;
    background-color: #3d3d3d;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-block;
    color: #e0e0e0;
    font-size: 0.9rem;
}

.tag-option:hover {
    background-color: #4d4d4d;
}

.tag-option.selected {
    background-color: #6a0dad;
    border: 2px solid #bb86fc;
    color: #fff;
}

/* --- ESTILOS PARA LA PREVISUALIZACIN DE SUBIDA DE NUEVAS IMGENES --- */
#image-upload-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 15px; /* Espacio entre las miniaturas */
    padding-top: 10px;
}

.image-preview-item {
    width: 150px; /* Tama帽o fijo para la previsualizaci贸n */
    flex-shrink: 0;
    background-color: #3d3d3d;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #555;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.image-preview-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-xl">
  <div class="card bg-dark text-light shadow-lg border-0 rounded-4 overflow-hidden mx-auto">
    <div class="card-header bg-dark">
      <h3 class="pt-2 text-white">Registrar Sitio Hist贸rico</h3>
    </div>
    {% if error %}
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}
    <div class="card-body text-white">
      <div class="bg-dark card p-4 border rounded-3 shadow-sm mb-5">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

        <form method="POST" action="{{ url_for('sites.create') }}" enctype="multipart/form-data" id="create-form">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="site_name" class="form-label text-white">Nombre del sitio</label>
              <input type="text" class="form-control" id="site_name" name="site_name" required>
            </div>
            <div class="col-md-6">
              <label for="short_desc" class="form-label text-white">Descripci贸n breve</label>
              <input type="text" class="form-control" id="short_desc" name="short_desc" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="full_desc" class="form-label text-white">Descripci贸n completa</label>
            <textarea class="form-control" id="full_desc" name="full_desc" required></textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="city" class="form-label text-white">Ciudad</label>
              <input type="text" class="form-control" id="city" name="city" required>
            </div>
            <div class="col-md-6">
              <label for="province" class="form-label text-white">Provincia</label>
              <input type="text" class="form-control" id="province" name="province" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="location" class="form-label text-white">Ubicaci贸n <span class="text-danger">*</span></label>
            <div id="map" style="height: 400px; width: 100%; border: 1px solid #ccc;"></div>
            <div class="mt-2">
              <small class="text-white">Haz clic en el mapa para seleccionar la ubicaci贸n</small>
            </div>
            <input type="hidden" id="latitude" name="latitude" required>
            <input type="hidden" id="longitude" name="longitude" required>
            <div class="mt-2">
              <span class="badge bg-info">Latitud: <span id="lat-display">No seleccionada</span></span>
              <span class="badge bg-info ms-2">Longitud: <span id="lon-display">No seleccionada</span></span>
            </div>
            <div id="coords-error" class="text-danger mt-1" style="display: none;">
              <i class="bi bi-exclamation-triangle"></i> Debe seleccionar una ubicaci贸n en el mapa
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="state_id" class="form-label text-white">Estado de conservaci贸n</label>
              <select class="form-control" id="state_id" name="state_id" required>
                <option value="">Seleccionar...</option>
                <option value="1">Bueno</option>
                <option value="2">Regular</option>
                <option value="3">Malo</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="operning_year" class="form-label text-white">A帽o de inauguraci贸n</label>
              <input type="number" class="form-control" id="operning_year" name="operning_year" required>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="category_id" class="form-label text-white">Categor铆a</label>
              <select class="form-control" id="category_id" name="category_id" required>
                <option value="">Seleccionar...</option>
                <option value="1">Arquitectura</option>
                <option value="2">Infraestructura</option>
                <option value="3">Sitio arqueol贸gico</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="active" class="form-label text-white">驴Visible en el portal?</label>
              <select class="form-control" id="active" name="active" required>
                <option value="true">S铆</option>
                <option value="false">No</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="tags" class="form-label text-white">Etiquetas</label>
            <div id="tags-container" class="tags-multiselect"> 
              {% for tag in tags %}
              <div class="tag-option" data-value="{{ tag.id }}">
                {{ tag.name }}
              </div>
              {% endfor %}
            </div>
            <input type="hidden" id="tags" name="tags" value="">
            <small class="form-text text-white">
              <i class="bi bi-info-circle"></i>
              Haz clic en las etiquetas para seleccionarlas. Las seleccionadas se ver谩n resaltadas.
            </small>
          </div>
          <div class="p-4 mb-4 border border-info rounded-3">
            <h5 class="text-white">Im谩genes para el Sitio (Opcional, M谩x 10)</h5>
            <div class="mb-3">
              <label for="images" class="form-label">Seleccionar archivos (M谩x 5MB c/u, JPG/PNG/WEBP)</label>
              <input class="form-control" type="file" id="images" name="images" multiple accept="image/jpeg,image/png,image/webp">
              <small class="form-text text-white">Puedes seleccionar hasta 10 im谩genes al crear el sitio.</small>
              <div id="image-upload-preview" class="mt-3">
                </div>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Registrar</button>
            <a href="{{ url_for('sites.index') }}" class="btn btn-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
  // Inicializar mapa
  var map = L.map('map').setView([-34.6037, -58.3816], 10); // Buenos Aires por defecto

  // Agregar capa de tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '漏 OpenStreetMap contributors'
  }).addTo(map);

  var marker = null;
  const form = document.getElementById('create-form');

  // Funci贸n para manejar clics en el mapa
  map.on('click', function (e) {
    var lat = e.latlng.lat;
    var lon = e.latlng.lng;

    // Actualizar campos ocultos
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lon;

    // Actualizar display
    document.getElementById('lat-display').textContent = lat.toFixed(6);
    document.getElementById('lon-display').textContent = lon.toFixed(6);

    // Agregar/actualizar marcador
    if (marker) {
      map.removeLayer(marker);
    }
    marker = L.marker([lat, lon]).addTo(map);

    // Ocultar mensaje de error si estaba visible
    document.getElementById('coords-error').style.display = 'none';
    document.getElementById('map').style.borderColor = '#ccc';
  });

  // Funci贸n para centrar en ubicaci贸n actual
  function getCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

        map.setView([lat, lon], 15);

        // Simular clic en la ubicaci贸n actual
        map.fire('click', { latlng: L.latLng(lat, lon) });
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Agregar bot贸n de ubicaci贸n actual
    var locationBtn = document.createElement('button');
    locationBtn.type = 'button';
    locationBtn.className = 'btn btn-outline-primary btn-sm mt-2';
    locationBtn.innerHTML = ' Usar mi ubicaci贸n actual';
    locationBtn.onclick = getCurrentLocation;
    document.getElementById('map').parentNode.appendChild(locationBtn);
    
    // Inicializar selecci贸n de tags
    initializeTagSelection();

    // --- L贸gica de Previsualizaci贸n y Metadatos para Subida de Nuevas Im谩genes ---
    const newImageInput = document.getElementById('images');
    const newPreviewContainer = document.getElementById('image-upload-preview'); // ID ajustado
    
    const MAX_TOTAL_IMAGES = 10;
    const MAX_FILE_SIZE_MB = 5;
    
    // Array para almacenar los archivos v谩lidos y mantener el orden
    // En la creaci贸n, todos los archivos son "nuevos"
    let newFilesArray = []; 

    function validateAndPreviewNewImages(files) {
        newPreviewContainer.innerHTML = '';
        newFilesArray = []; // Reiniciar la lista de archivos v谩lidos
        
        const filesToProcess = Array.from(files);
        
        if (filesToProcess.length === 0) {
            return;
        }

        if (filesToProcess.length > MAX_TOTAL_IMAGES) {
            alert(`Solo puedes subir hasta ${MAX_TOTAL_IMAGES} im谩genes.`);
            newImageInput.value = ''; // Limpiar el input file
            return;
        }

        let validFiles = true;

        filesToProcess.forEach((file, index) => {
            const fileSizeMB = file.size / (1024 * 1024);
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const ALLOWED_EXTENSIONS = ['jpg', 'png', 'webp', 'jpeg']; 

            if (fileSizeMB > MAX_FILE_SIZE_MB || !ALLOWED_EXTENSIONS.includes(fileExtension)) {
                alert(`El archivo ${file.name} es inv谩lido (tama帽o > ${MAX_FILE_SIZE_MB}MB o formato no permitido).`);
                validFiles = false;
                return; 
            }
            
            // Archivo v谩lido: A帽adir al array para mantener la referencia
            newFilesArray.push(file);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item'; 
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = `Previsualizaci贸n de ${file.name}`;
                    
                    const titleLabel = document.createElement('label');
                    titleLabel.className = 'form-label small mb-0 mt-1 text-white';
                    titleLabel.textContent = 'T铆tulo/Alt *';
                    
                    // T铆tulo/Alt obligatorio
                    const titleInput = document.createElement('input');
                    titleInput.type = 'text';
                    titleInput.name = `new_title_alt_${index}`; 
                    titleInput.className = 'form-control form-control-sm mb-1 te';
                    titleInput.placeholder = 'T铆tulo/Alt (obligatorio)';
                    titleInput.required = true;

                    // Descripci贸n
                    const descLabel = document.createElement('label');
                    descLabel.className = 'form-label small mb-0 mt-1 text-white' ;
                    descLabel.textContent = 'Descripci贸n (opcional)';

                    const descTextarea = document.createElement('textarea');
                    descTextarea.name = `new_description_${index}`; 
                    descTextarea.className = 'form-control form-control-sm';
                    descTextarea.rows = '2';
                    descTextarea.placeholder = 'Descripci贸n (opcional)';
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(titleLabel);
                    previewItem.appendChild(titleInput);
                    previewItem.appendChild(descLabel);
                    previewItem.appendChild(descTextarea);
                    newPreviewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Si hay archivos inv谩lidos, forzar a limpiar el input y el array
        if (!validFiles) {
            newImageInput.value = '';
            newFilesArray = [];
            newPreviewContainer.innerHTML = '';
        }
    }

    newImageInput.addEventListener('change', function() {
        validateAndPreviewNewImages(this.files);
    });
    
    // --- Validaci贸n Final antes del env铆o ---
    form.addEventListener('submit', function(e) {
        const latInput = document.getElementById('latitude');
        const lonInput = document.getElementById('longitude');
        const coordsError = document.getElementById('coords-error');

        //  Validaci贸n de Coordenadas
        if (!latInput.value || !lonInput.value) {
            e.preventDefault();
            coordsError.style.display = 'block';
            document.getElementById('map').style.borderColor = '#dc3545';
            alert('Por favor, selecciona una ubicaci贸n en el mapa.');
            return;
        } else {
            coordsError.style.display = 'none';
        }
        
        // Validaci贸n de T铆tulo/Alt para im谩genes nuevas (si hay archivos seleccionados)
        if (newFilesArray.length > 0) {
            const titleInputs = newPreviewContainer.querySelectorAll('input[type="text"][required]');
            let allTitlesFilled = true;
            
            titleInputs.forEach(input => {
                if (!input.value.trim()) {
                    allTitlesFilled = false;
                    input.focus();
                    input.style.borderColor = '#dc3545';
                } else {
                    input.style.borderColor = '';
                }
            });
            
            if (!allTitlesFilled) {
                e.preventDefault();
                alert('Por favor, complete el T铆tulo/Alt obligatorio para todas las im谩genes.');
            }
        }
        
        // Si todo es v谩lido, el formulario se env铆a
    });
  });


  // Funci贸n para inicializar la selecci贸n m煤ltiple de tags (Copiada de la template de edici贸n)
  function initializeTagSelection() {
      const tagOptions = document.querySelectorAll('.tag-option');
      const hiddenInput = document.getElementById('tags');
      const selectedTags = new Set();
      
      // En la creaci贸n, el valor inicial es vac铆o, no necesitamos parsing
      
      tagOptions.forEach(option => {
          
          option.addEventListener('click', function() {
              const value = this.getAttribute('data-value');
              
              if (selectedTags.has(value)) {
                  selectedTags.delete(value);
                  this.classList.remove('selected');
              } else {
                  selectedTags.add(value);
                  this.classList.add('selected');
              }
              
              hiddenInput.value = Array.from(selectedTags).join(',');
          });
      });
  }
</script>

{% endblock %}