{% extends "layout.html" %}

{% block title %}Registrar Sitio Hist贸rico | Puff-t贸ricos{% endblock %}

{% block content %}
<div class="container-xl">
  <div class="card bg-dark text-light shadow-lg border-0 rounded-4 overflow-hidden mx-auto">
    <div class="card-header bg-dark">
      <h3 class="pt-2 text-white">Registrar Sitio Hist贸rico</h3>
    </div>
    {% if error %}
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}
    <div class="card-body text-white">
      <div class="bg-dark card p-4 border rounded-3 shadow-sm mb-5">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

        <form method="POST" action="{{ url_for('sites.create') }}" enctype="multipart/form-data">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="site_name" class="form-label text-white">Nombre del sitio</label>
              <input type="text" class="form-control" id="site_name" name="site_name" required>
            </div>
            <div class="col-md-6">
              <label for="short_desc" class="form-label text-white">Descripci贸n breve</label>
              <input type="text" class="form-control" id="short_desc" name="short_desc" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="full_desc" class="form-label text-white">Descripci贸n completa</label>
            <textarea class="form-control" id="full_desc" name="full_desc" required></textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="city" class="form-label text-white">Ciudad</label>
              <input type="text" class="form-control" id="city" name="city" required>
            </div>
            <div class="col-md-6">
              <label for="province" class="form-label text-white">Provincia</label>
              <input type="text" class="form-control" id="province" name="province" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="location" class="form-label text-white">Ubicaci贸n <span class="text-danger">*</span></label>
            <div id="map" style="height: 400px; width: 100%; border: 1px solid #ccc;"></div>
            <div class="mt-2">
              <small class="text-white">Haz clic en el mapa para seleccionar la ubicaci贸n</small>
            </div>
            <input type="hidden" id="latitude" name="latitude" required>
            <input type="hidden" id="longitude" name="longitude" required>
            <div class="mt-2">
              <span class="badge bg-info">Latitud: <span id="lat-display">No seleccionada</span></span>
              <span class="badge bg-info ms-2">Longitud: <span id="lon-display">No seleccionada</span></span>
            </div>
            <div id="coords-error" class="text-danger mt-1" style="display: none;">
              <i class="bi bi-exclamation-triangle"></i> Debe seleccionar una ubicaci贸n en el mapa
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="state_id" class="form-label text-white">Estado de conservaci贸n</label>
              <select class="form-control" id="state_id" name="state_id" required>
                <option value="">Seleccionar...</option>
                <option value="1">Bueno</option>
                <option value="2">Regular</option>
                <option value="3">Malo</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="operning_year" class="form-label text-white">A帽o de inauguraci贸n</label>
              <input type="number" class="form-control" id="operning_year" name="operning_year" required>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="category_id" class="form-label text-white">Categor铆a</label>
              <select class="form-control" id="category_id" name="category_id" required>
                <option value="">Seleccionar...</option>
                <option value="1">Arquitectura</option>
                <option value="2">Infraestructura</option>
                <option value="3">Sitio arqueol贸gico</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="active" class="form-label text-white">驴Visible en el portal?</label>
              <select class="form-control" id="active" name="active" required>
                <option value="true">S铆</option>
                <option value="false">No</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="tags" class="form-label text-white">Etiquetas</label>
            <div id="tags-container" class="tags-multiselect"
              style="border: 1px solid #4b0082; border-radius: 4px; padding: 8px; min-height: 120px; background-color: #2d2d2d; max-height: 200px; overflow-y: auto; color: white;">
              {% for tag in tags %}
              <div class="tag-option" data-value="{{ tag.id }}"
                style="padding: 6px 12px; margin: 2px; background-color: #3d3d3d; border-radius: 4px; cursor: pointer; transition: all 0.2s; display: inline-block;">
                {{ tag.name }}
              </div>
              {% endfor %}
            </div>
            <input type="hidden" id="tags" name="tags" value="">
            <small class="form-text text-white">
              <i class="bi bi-info-circle"></i>
              Haz clic en las etiquetas para seleccionarlas. Las seleccionadas se ver谩n resaltadas.
            </small>
          </div>
          <div class="p-4 mb-4 border border-info rounded-3">
            <h5 class="text-white">Im谩genes para el Sitio (Opcional, M谩x 10)</h5>
            <div class="mb-3">
              <label for="images" class="form-label">Seleccionar archivos (M谩x 5MB c/u, JPG/PNG/WEBP)</label>
              <input class="form-control" type="file" id="images" name="images" multiple accept="image/jpeg,image/png,image/webp">
              <small class="form-text text-white">Puedes seleccionar hasta 10 im谩genes al crear el sitio.</small>
              <div id="image-upload-preview" class="mt-3 d-flex flex-wrap gap-3">
                </div>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Registrar</button>
            <a href="{{ url_for('sites.index') }}" class="btn btn-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
  // Inicializar mapa
  var map = L.map('map').setView([-34.6037, -58.3816], 10); // Buenos Aires por defecto

  // Agregar capa de tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '漏 OpenStreetMap contributors'
  }).addTo(map);

  var marker = null;

  // Funci贸n para manejar clics en el mapa
  map.on('click', function (e) {
    var lat = e.latlng.lat;
    var lon = e.latlng.lng;

    // Actualizar campos ocultos
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lon;

    // Actualizar display
    document.getElementById('lat-display').textContent = lat.toFixed(6);
    document.getElementById('lon-display').textContent = lon.toFixed(6);

    // Agregar/actualizar marcador
    if (marker) {
      map.removeLayer(marker);
    }
    marker = L.marker([lat, lon]).addTo(map);

    // Ocultar mensaje de error si estaba visible
    document.getElementById('coords-error').style.display = 'none';
    document.getElementById('map').style.borderColor = '#ccc';
  });

  // Funci贸n para centrar en ubicaci贸n actual
  function getCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

        map.setView([lat, lon], 15);

        // Simular clic en la ubicaci贸n actual
        map.fire('click', { latlng: L.latLng(lat, lon) });
      });
    }
  }

  // Bot贸n para ubicaci贸n actual
  document.addEventListener('DOMContentLoaded', function () {
    var locationBtn = document.createElement('button');
    locationBtn.type = 'button';
    locationBtn.className = 'btn btn-outline-primary btn-sm mt-2';
    locationBtn.innerHTML = ' Usar mi ubicaci贸n actual';
    locationBtn.onclick = getCurrentLocation;

    document.getElementById('map').parentNode.appendChild(locationBtn);

    // Inicializar selecci贸n m煤ltiple de tags
    initializeTagSelection();

    // Validaci贸n del formulario antes del env铆o
    var form = document.querySelector('form');
    form.addEventListener('submit', function (e) {
      var latInput = document.getElementById('latitude');
      var lonInput = document.getElementById('longitude');

      // Verificar si se han seleccionado coordenadas
      if (!latInput.value || !lonInput.value) {
        e.preventDefault();
        document.getElementById('coords-error').style.display = 'block';
        document.getElementById('map').style.borderColor = '#dc3545';
        return false;
      } else {
        document.getElementById('coords-error').style.display = 'none';
        document.getElementById('map').style.borderColor = '#ccc';
      }

      // Verificar que las coordenadas sean v谩lidas
      try {
        var lat = parseFloat(latInput.value);
        var lon = parseFloat(lonInput.value);

        if (isNaN(lat) || isNaN(lon)) {
          e.preventDefault();
          alert('Las coordenadas seleccionadas no son v谩lidas.');
          return false;
        }

        if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
          e.preventDefault();
          alert('Las coordenadas seleccionadas est谩n fuera del rango v谩lido.');
          return false;
        }
      } catch (error) {
        e.preventDefault();
        alert('Error al validar las coordenadas.');
        return false;
      }

      // Validar im谩genes
      const imageInput = document.getElementById('images');
      const files = imageInput.files;
      const MAX_IMAGES = 10;
      const MAX_FILE_SIZE_MB = 5; // MB
      const ALLOWED_EXTENSIONS = ['jpg', 'png', 'webp'];

      if (files.length > MAX_IMAGES) {
          e.preventDefault();
          alert(`Solo puedes subir un m谩ximo de ${MAX_IMAGES} im谩genes.`);
          return false;
      }

      for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileSizeMB = file.size / (1024 * 1024); // Convertir a MB
          const fileExtension = file.name.split('.').pop().toLowerCase();

          if (fileSizeMB > MAX_FILE_SIZE_MB) {
              e.preventDefault();
              alert(`El archivo ${file.name} excede el tama帽o m谩ximo de ${MAX_FILE_SIZE_MB} MB.`);
              return false;
          }
          if (!ALLOWED_EXTENSIONS.includes(fileExtension)) {
              e.preventDefault();
              alert(`El archivo ${file.name} tiene un formato no permitido. Solo se permiten JPG, PNG, WEBP.`);
              return false;
          }
      }

    });

    // --- L贸gica de previsualizaci贸n de im谩genes ---
    const imageInput = document.getElementById('images');
    const previewContainer = document.getElementById('image-upload-preview');
    let fileList = [];
    new Sortable(previewContainer, {
        animation: 150,
        ghostClass: 'bg-secondary',
        handle: '.image-preview-item', // Permite arrastrar desde el elemento completo
        onEnd: function (evt) {
            // Llamar a la funci贸n para reordenar la lista y actualizar los nombres
            reorderFilesAndInputs();
        }
    });

    // Funci贸n que maneja la selecci贸n de archivos
    imageInput.addEventListener('change', function() {
        previewContainer.innerHTML = ''; // Limpiar previsualizaciones anteriores
        
        const files = this.files;
        const MAX_IMAGES = 10;

        if (files.length > MAX_IMAGES) {
            alert(`Solo puedes seleccionar un m谩ximo de ${MAX_IMAGES} im谩genes.`);
            this.value = ''; // Limpiar selecci贸n
            fileList = []; // Limpiar lista
            return;
        }

        // Guardar la lista de archivos en la variable global
        fileList = Array.from(files);

        // Generar previsualizaciones
        fileList.forEach((file, index) => {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item border p-2 rounded';
                    // A帽adir estilo para cursor de arrastre
                    previewItem.style.cursor = 'grab';
                    previewItem.style.width = '120px'; 
                    previewItem.style.height = 'auto';
                    previewItem.style.backgroundColor = '#3d3d3d';
                    // Almacenar el 铆ndice original del archivo para referencia
                    previewItem.setAttribute('data-file-index', index); 
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = `Previsualizaci贸n de ${file.name}`;
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '4px';
                    img.className = 'mb-2';

                    // Los nombres de los inputs se establecer谩n en reorderFilesAndInputs()

                    const titleInput = document.createElement('input');
                    titleInput.type = 'text';
                    titleInput.className = 'form-control form-control-sm mb-1 image-title-input'; // Clase para identificar
                    titleInput.placeholder = 'T铆tulo/Alt (obligatorio)';
                    titleInput.required = true;

                    const descTextarea = document.createElement('textarea');
                    descTextarea.className = 'form-control form-control-sm image-desc-input'; // Clase para identificar
                    descTextarea.rows = '2';
                    descTextarea.placeholder = 'Descripci贸n (opcional)';
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(titleInput);
                    previewItem.appendChild(descTextarea);
                    previewContainer.appendChild(previewItem);
                    
                    // Aseguramos que los inputs tengan sus nombres correctos inicialmente
                    reorderFilesAndInputs(); 
                };
                reader.readAsDataURL(file);
            }
        });
    });
    
    // Funci贸n para reordenar la lista y actualizar nombres de inputs
    function reorderFilesAndInputs() {
        const items = Array.from(previewContainer.querySelectorAll('.image-preview-item'));
        
        // Crear la nueva lista de archivos reordenada
        const reorderedFiles = [];
        const dataTransfer = new DataTransfer();

        items.forEach((item, newIndex) => {
            // Obtener el 铆ndice original del archivo
            const originalIndex = parseInt(item.getAttribute('data-file-index'));
            
            // A帽adir el archivo original a la nueva lista reordenada
            reorderedFiles.push(fileList[originalIndex]);

            // Renombrar los inputs de metadatos seg煤n la nueva posici贸n (0, 1, 2...)
            const titleInput = item.querySelector('.image-title-input');
            const descInput = item.querySelector('.image-desc-input');
            
            // Asegurarse de que el 铆ndice refleje el nuevo orden
            titleInput.name = `title_alt_${newIndex}`;
            descInput.name = `description_${newIndex}`;
            
            // Actualizar el 铆ndice de datos del elemento (para mantener la referencia)
            item.setAttribute('data-file-index', newIndex);
            
            // Agregar el archivo al nuevo objeto DataTransfer para reasignarlo al input file
            dataTransfer.items.add(fileList[originalIndex]);
        });

        // Reemplazar la lista de archivos global y en el input de tipo file
        fileList = reorderedFiles;
        imageInput.files = dataTransfer.files;
        
        console.log("Archivos y nombres de inputs reordenados.");
      }
  });
  

  // Funci贸n para inicializar la selecci贸n m煤ltiple de tags
  function initializeTagSelection() {
    const tagOptions = document.querySelectorAll('.tag-option');
    const hiddenInput = document.getElementById('tags');
    const selectedTags = new Set();

    tagOptions.forEach(option => {
      option.addEventListener('click', function () {
        const value = this.getAttribute('data-value');

        if (selectedTags.has(value)) {
          // Deseleccionar
          selectedTags.delete(value);
          this.style.backgroundColor = '#3d3d3d';
          this.style.border = 'none';
        } else {
          // Seleccionar
          selectedTags.add(value);
          this.style.backgroundColor = '#6a0dad';
          this.style.border = '2px solid #bb86fc';
        }

        // Actualizar input hidden con los valores seleccionados
        hiddenInput.value = Array.from(selectedTags).join(',');
      });

      // Estilo hover
      option.addEventListener('mouseenter', function () {
        if (!selectedTags.has(this.getAttribute('data-value'))) {
          this.style.backgroundColor = '#4d4d4d';
        }
      });

      option.addEventListener('mouseleave', function () {
        if (!selectedTags.has(this.getAttribute('data-value'))) {
          this.style.backgroundColor = '#3d3d3d';
        }
      });
    });
  }
</script>

{% endblock %}