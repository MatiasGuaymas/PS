{% extends "layout.html" %}

{% block title %}Panel de Feature Flags | Puff-tóricos{% endblock %}

{% block content %}
<div class="container-xl">
    <div class="card bg-dark text-light shadow-lg border-0 rounded-4 overflow-hidden mx-auto">
        <div class="p-4">
            <h3 class="h3 fw-bolder mb-1 text-white">Gestión de Feature Flags</h3>
            <p class="text-white-50">Administrá las flags del sistema y sus estados.</p>
            <div class="table-responsive">
                <table class="table table-dark table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">Nombre</th>
                            <th scope="col">Descripción</th>
                            <th scope="col" class="text-center">Estado</th>
                            <th scope="col" class="text-center">Mensaje (si aplica)</th>
                            <th scope="col">Última modificación</th>
                            <th scope="col">Usuario</th>
                            <th scope="col" class="text-center">Toggle</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for flag in flags %}
                        {% set is_maint = flag.is_maintenance %}
                        <tr id="flag-row-{{ flag.id }}" class="{{ 'table-warning' if flag.is_enabled and is_maint else '' }}">
                            <td class="text-white"><strong>{{ flag.name }}</strong></td>
                            <td class="text-white">{{ flag.description }}</td>
                            <td class="text-center">
                                {% if flag.is_enabled %}
                                    <span class="badge bg-success">ACTIVO</span>
                                {% else %}
                                    <span class="badge bg-danger">INACTIVO</span>
                                {% endif %}
                            </td>
                            <td class="text-white">
                                <small>{{ flag.message or 'No hay un mensaje' }}</small>
                            </td>
                            <td class="text-white">
                                <small>{{ flag.last_edit.strftime("%d/%m/%y %H:%M") }}</small>
                            </td>
                            <td class="text-white">
                                <small>{{ flag.user_email or 'Sistema/Seeds' }}</small>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-inline-block">
                                    <input 
                                        class="form-check-input toggle-switch-input" 
                                        type="checkbox" 
                                        role="switch" 
                                        id="flagSwitch-{{ flag.id }}"
                                        data-flag-id="{{ flag.id }}"
                                        data-is-maintenance="{{ 'true' if is_maint else 'false' }}"
                                        {% if flag.is_enabled %}checked{% endif %}
                                    >
                                    <label class="form-check-label visually-hidden" for="flagSwitch-{{ flag.id }}">Toggle</label>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="maintenanceModal" tabindex="-1" aria-labelledby="maintenanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="maintenance-form" method="POST">
                <input type="hidden" id="modal-current-flag-id" name="flag_id_in_modal" value=""> 
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="maintenanceModalLabel">Activar Modo Mantenimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">Debe ingresar un mensaje de mantenimiento para activar esta funcionalidad.</p>
                    <div class="mb-3">
                        <label for="maintenance-message" class="form-label fw-semibold">Mensaje de Mantenimiento:</label>
                        <textarea class="form-control rounded-3" id="maintenance-message" name="message" rows="3" maxlength="100" required></textarea>
                        <small class="text-muted">Máximo 100 caracteres (según tu modelo).</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-3 px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning rounded-3 px-4">Activar y Guardar Mensaje</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleSwitches = document.querySelectorAll('.toggle-switch-input');
        const maintenanceModalEl = document.getElementById('maintenanceModal');
        // Inicializar el objeto Modal de Bootstrap.
        // Asegúrate de tener el script de Bootstrap 5 cargado ANTES que este script.
        const maintenanceModal = new bootstrap.Modal(maintenanceModalEl); 
        const maintenanceForm = document.getElementById('maintenance-form');
        const modalFlagIdInput = document.getElementById('modal-current-flag-id');
        const maintenanceMessageInput = document.getElementById('maintenance-message');
        
        const TOGGLE_URL_TEMPLATE = "{{ url_for('feature-flags.toggle', flag_id=0) }}"; 
        // 1. Escucha cambios en todos los switches
        toggleSwitches.forEach(switchElement => {
            switchElement.addEventListener('change', function(event) {
                const flagId = this.dataset.flagId;
                // Convertir la cadena 'true'/'false' a booleano
                const isMaintenance = this.dataset.isMaintenance === 'true'; 
                const newState = this.checked;
                
                const actionUrl = TOGGLE_URL_TEMPLATE.replace('0', flagId);                // A. Lógica de Activación de Mantenimiento (Requiere Modal)
                if (isMaintenance && newState) {
                    // Prevenir el comportamiento predeterminado (el POST)
                    // y dejar que el modal lo maneje después de obtener el mensaje.
                    event.preventDefault(); 
                    
                    // 1. Configurar el modal:
                    // Guardamos el ID en el input oculto para usarlo en la acción del POST y la reversión
                    modalFlagIdInput.value = flagId; 
                    // Configuramos la acción del formulario del modal
                    maintenanceForm.action = actionUrl;
                    // Limpiamos el mensaje previo
                    maintenanceMessageInput.value = '';
                    
                    // 2. Mostrar el modal
                    maintenanceModal.show();
                    
                } else {
                    // B. Lógica de Desactivación O Activación de Flags Normales (Envío Directo)
                    
                    // Crear y enviar formulario dinámico (¡Funciona correctamente!)
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = actionUrl;
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
        

        // 2. Manejar el cierre del modal (CANCELACIÓN O CIERRE MANUAL)
        maintenanceModalEl.addEventListener('hidden.bs.modal', function () {
            const flagId = modalFlagIdInput.value;
            const currentSwitch = document.getElementById(`flagSwitch-${flagId}`);

            // Si el modal se cerró sin enviar el formulario (que causa una redirección), 
            // el switch debe revertirse a su estado original (desactivado).
            if (currentSwitch) {
                currentSwitch.checked = false;
            }

            // Limpiar la referencia
            modalFlagIdInput.value = '';
        });

        // 3. Manejar el envío del formulario dentro del modal
        maintenanceForm.addEventListener('submit', function(event) {
        });
    });
</script>
{% endblock %}